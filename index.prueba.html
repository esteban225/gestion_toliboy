<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Prueba Notificaciones Pusher</title>
  <script src="https://js.pusher.com/8.2/pusher.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #messages p { margin: 0.5em 0; }
    #error { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h2>üîî Esperando notificaciones...</h2>
  <div id="messages"></div>

  <script>
    // üß© ID del usuario autenticado
    const userId = 1; // ‚ö†Ô∏è Cambia este valor por el ID real del usuario logueado

    // ‚öôÔ∏è Configura Pusher con tu clave y cluster correctos
    const pusher = new Pusher("3cfb434018939310b096", {
      cluster: "us2",
      forceTLS: true,
      debug: true,
    });

    // üîé Mostrar errores de conexi√≥n de Pusher
    pusher.connection.bind("error", function (err) {
      let errorDiv = document.getElementById("error");
      if (!errorDiv) {
        errorDiv = document.createElement("div");
        errorDiv.id = "error";
        document.body.insertBefore(errorDiv, document.getElementById("messages"));
      }
      errorDiv.textContent =
        "‚ùå Error de conexi√≥n Pusher: " +
        (err.error ? err.error.data.message : JSON.stringify(err));
      console.error("Pusher error:", err);
    });

    // üì° Suscribirse al canal individual del usuario
    const userChannel = pusher.subscribe(`notifications.${userId}`);

    userChannel.bind("pusher:subscription_succeeded", function () {
      console.log(`‚úÖ Suscrito correctamente al canal: notifications.${userId}`);
    });

    userChannel.bind("pusher:subscription_error", function (status) {
      console.error(`‚ùå Error al suscribirse al canal: ${status}`);
    });

    // üì° (Opcional) Suscribirse tambi√©n al canal global
    const globalChannel = pusher.subscribe("notifications.global");

    globalChannel.bind("pusher:subscription_succeeded", function () {
      console.log("‚úÖ Suscrito correctamente al canal: notifications.global");
    });

    // üì¨ Escuchar el evento notification.created (en ambos canales)
    function mostrarNotificacion(origen, data) {
      console.log(`üì¢ Nueva notificaci√≥n desde ${origen}:`, data);
      const div = document.getElementById("messages");
      const message = document.createElement("p");
      message.textContent = `üîî [${origen}] ${data.title ?? data.message ?? JSON.stringify(data)}`;
      div.appendChild(message);
    }

    userChannel.bind("notification.created", (data) =>
      mostrarNotificacion(`notifications.${userId}`, data)
    );

    globalChannel.bind("notification.created", (data) =>
      mostrarNotificacion("notifications.global", data)
    );

    // ‚ö†Ô∏è Verifica que el backend tenga:
    // BROADCAST_DRIVER=pusher
    // PUSHER_APP_KEY=3cfb434018939310b096
    // PUSHER_APP_CLUSTER=us2
    // y que use "new Channel('notifications.' . $userId)" o "notifications.global"
  </script>
</body>
</html>
